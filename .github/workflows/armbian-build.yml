name: Build Armbian Image

on:
  schedule:
    # Run daily at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build regardless of version change'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  check-version:
    name: Check Upstream Version
    runs-on: ubuntu-latest
    outputs:
      build_needed: ${{ steps.check.outputs.build_needed }}
      upstream_version: ${{ steps.check.outputs.upstream_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check upstream VERSION
        id: check
        run: |
          # Fetch current upstream VERSION from armbian/build
          UPSTREAM_VERSION=$(curl -sL https://raw.githubusercontent.com/armbian/build/main/VERSION | tr -d '\n\r')
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "Upstream Armbian version: $UPSTREAM_VERSION"

          # Get last built version from images.json
          LAST_BUILT=""
          if [ -f images.json ]; then
            LAST_BUILT=$(jq -r '.latest.armbian_version // ""' images.json)
          fi
          echo "Last built version: $LAST_BUILT"

          # Determine if build is needed
          if [ "$UPSTREAM_VERSION" != "$LAST_BUILT" ] || [ "${{ inputs.force_build }}" == "true" ]; then
            echo "build_needed=true" >> $GITHUB_OUTPUT
            echo "Build needed: version changed or force build requested"
          else
            echo "build_needed=false" >> $GITHUB_OUTPUT
            echo "Build not needed: version unchanged"
          fi

  build:
    name: Build Armbian
    needs: check-version
    if: needs.check-version.outputs.build_needed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Maximize build space
        uses: easimon/maximize-build-space@c28619d8999a147d5e09c1199f84ff6af6ad5794 # master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1024
          build-mount-path: /build
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Check available space
        run: df -h

      - name: Move Docker to larger partition
        run: |
          sudo systemctl stop docker
          sudo mv /var/lib/docker /build/docker
          sudo ln -s /build/docker /var/lib/docker
          sudo systemctl start docker
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rclone

      - name: Set up QEMU for ARM64 cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,arm

      - name: Clone Armbian build framework
        run: |
          git clone --depth=1 https://github.com/armbian/build /build/armbian-build

      - name: Build Armbian image
        run: |
          cd /build/armbian-build
          ./compile.sh build \
            BOARD=turing-rk1 \
            BRANCH=vendor \
            RELEASE=bookworm \
            BUILD_MINIMAL=no \
            BUILD_DESKTOP=no \
            KERNEL_CONFIGURE=no \
            COMPRESS_OUTPUTIMAGE=xz,sha

          # Copy output to workspace
          mkdir -p $GITHUB_WORKSPACE/armbian-build/output/images
          cp -v /build/armbian-build/output/images/*.img.xz $GITHUB_WORKSPACE/armbian-build/output/images/ || true
          cp -v /build/armbian-build/output/images/*.sha $GITHUB_WORKSPACE/armbian-build/output/images/ || true
          cp -v /build/armbian-build/output/images/*.txt $GITHUB_WORKSPACE/armbian-build/output/images/ || true
          ls -la $GITHUB_WORKSPACE/armbian-build/output/images/

      - name: Extract image metadata
        id: metadata
        run: |
          # Find the built image
          IMAGE_FILE=$(ls armbian-build/output/images/*.img.xz 2>/dev/null | head -1)
          if [ -z "$IMAGE_FILE" ]; then
            echo "Error: No image file found"
            exit 1
          fi

          FILENAME=$(basename "$IMAGE_FILE")
          SIZE=$(stat -c%s "$IMAGE_FILE")
          SIZE_HUMAN=$(numfmt --to=iec-i --suffix=B "$SIZE")
          SHA256=$(sha256sum "$IMAGE_FILE" | cut -d' ' -f1)

          # Extract kernel version from filename
          KERNEL=$(echo "$FILENAME" | grep -oP '\d+\.\d+\.\d+' | tail -1)

          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_human=$SIZE_HUMAN" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "kernel=$KERNEL" >> $GITHUB_OUTPUT

          echo "Image: $FILENAME"
          echo "Size: $SIZE_HUMAN"
          echo "SHA256: $SHA256"
          echo "Kernel: $KERNEL"

      - name: Configure rclone for Cloudflare R2
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = ${{ secrets.R2_ENDPOINT }}
          region = auto
          EOF
          rclone listremotes

      - name: Upload to Cloudflare R2
        id: upload
        run: |
          VERSION="${{ needs.check-version.outputs.upstream_version }}"
          FILENAME="${{ steps.metadata.outputs.filename }}"
          IMAGE_FILE="armbian-build/output/images/$FILENAME"
          BUCKET="armbian-builds"

          # Upload image file to armbian/ subdirectory
          rclone copy "$IMAGE_FILE" "r2:${BUCKET}/turing-rk1/armbian/${VERSION}/" --progress --s3-chunk-size=64M

          # Upload checksum and info files
          rclone copy "armbian-build/output/images/" "r2:${BUCKET}/turing-rk1/armbian/${VERSION}/" --include "*.sha" --include "*.txt" --progress

          # Construct public URL (requires R2 public access enabled)
          R2_PUBLIC_URL="${{ secrets.R2_PUBLIC_URL }}"
          if [ -n "$R2_PUBLIC_URL" ]; then
            DOWNLOAD_URL="${R2_PUBLIC_URL}/turing-rk1/armbian/${VERSION}/${FILENAME}"
          else
            DOWNLOAD_URL="${{ secrets.R2_ENDPOINT }}/armbian-builds/turing-rk1/armbian/${VERSION}/${FILENAME}"
          fi
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "Uploaded to: $DOWNLOAD_URL"

          # List uploaded files
          echo "Uploaded files:"
          rclone ls "r2:${BUCKET}/turing-rk1/armbian/${VERSION}/"

      - name: Update images.json
        run: |
          VERSION="${{ needs.check-version.outputs.upstream_version }}"
          DATE=$(date -u +%Y-%m-%d)
          DOWNLOAD_URL="${{ steps.upload.outputs.download_url }}"

          # Initialize images.json if it doesn't exist
          if [ ! -f images.json ]; then
            echo '{"history":[],"build_config":{"board":"turing-rk1","branch":"vendor","release":"bookworm"}}' > images.json
          fi

          # Update images.json with new metadata
          jq --arg version "$VERSION" \
             --arg kernel "${{ steps.metadata.outputs.kernel }}" \
             --arg date "$DATE" \
             --arg filename "${{ steps.metadata.outputs.filename }}" \
             --arg size "${{ steps.metadata.outputs.size }}" \
             --arg sha256 "${{ steps.metadata.outputs.sha256 }}" \
             --arg download_url "$DOWNLOAD_URL" \
          '.latest = {
            armbian_version: $version,
            kernel_version: $kernel,
            release: "bookworm",
            branch: "vendor",
            build_date: $date,
            filename: $filename,
            size_bytes: ($size | tonumber),
            sha256: $sha256,
            download_url: $download_url
          } | .history = ([{
            armbian_version: $version,
            build_date: $date,
            download_url: $download_url
          }] + .history[0:9])' images.json > images.json.tmp && mv images.json.tmp images.json

          echo "Updated images.json:"
          cat images.json

      - name: Update unified images.json in R2
        run: |
          VERSION="${{ needs.check-version.outputs.upstream_version }}"
          DATE=$(date -u +%Y-%m-%d)
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          DOWNLOAD_URL="${{ steps.upload.outputs.download_url }}"
          R2_PUBLIC_URL="${{ secrets.R2_PUBLIC_URL }}"
          BUCKET="armbian-builds"

          # Download current unified images.json from R2
          curl -sL "${R2_PUBLIC_URL}/turing-rk1/images.json" -o r2-images.json || echo '{}' > r2-images.json

          # Get previous version info for history
          PREV_VERSION=$(jq -r '.armbian.latest.version // ""' r2-images.json)
          PREV_URL=$(jq -r '.armbian.latest.download_url // ""' r2-images.json)
          PREV_DATE=$(jq -r '.armbian.latest.build_date // ""' r2-images.json)

          # Update the armbian section in unified images.json
          jq --arg version "$VERSION" \
             --arg kernel "${{ steps.metadata.outputs.kernel }}" \
             --arg date "$DATE" \
             --arg timestamp "$TIMESTAMP" \
             --arg filename "${{ steps.metadata.outputs.filename }}" \
             --arg size "${{ steps.metadata.outputs.size }}" \
             --arg sha256 "${{ steps.metadata.outputs.sha256 }}" \
             --arg download_url "$DOWNLOAD_URL" \
             --arg prev_version "$PREV_VERSION" \
             --arg prev_url "$PREV_URL" \
             --arg prev_date "$PREV_DATE" \
          '
          .updated_at = $timestamp |
          .schema_version = "1.0" |

          # Move current to history if different version
          (if $prev_version != "" and $prev_version != "null" and $prev_version != $version then
            .armbian.history = ([{
              version: $prev_version,
              build_date: $prev_date,
              download_url: $prev_url
            }] + (.armbian.history // [])[0:9])
          else
            .
          end) |

          # Update latest
          .armbian.latest = {
            version: $version,
            kernel_version: $kernel,
            release: "bookworm",
            branch: "vendor",
            build_date: $date,
            filename: $filename,
            size_bytes: ($size | tonumber),
            sha256: $sha256,
            download_url: $download_url
          } |

          # Ensure config exists
          .armbian.config = {
            board: "turing-rk1",
            branch: "vendor",
            release: "bookworm",
            build_minimal: false,
            build_desktop: false
          }
          ' r2-images.json > r2-images.json.tmp && mv r2-images.json.tmp r2-images.json

          echo "Updated unified images.json:"
          jq '.armbian' r2-images.json

          # Upload to R2
          rclone copy r2-images.json "r2:${BUCKET}/turing-rk1/" --progress
          echo "Unified images.json uploaded to R2"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images.json
          git diff --cached --quiet || git commit -m "Update Armbian image metadata for version ${{ needs.check-version.outputs.upstream_version }}"
          git push
