name: Build Armbian Image

on:
  schedule:
    # Run daily at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build regardless of version change'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  check-version:
    name: Check Upstream Version
    runs-on: ubuntu-latest
    outputs:
      build_needed: ${{ steps.check.outputs.build_needed }}
      upstream_version: ${{ steps.check.outputs.upstream_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check upstream VERSION
        id: check
        run: |
          # Fetch current upstream VERSION from armbian/build
          UPSTREAM_VERSION=$(curl -sL https://raw.githubusercontent.com/armbian/build/main/VERSION | tr -d '\n\r')
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "Upstream Armbian version: $UPSTREAM_VERSION"

          # Get last built version from images.json
          LAST_BUILT=""
          if [ -f images.json ]; then
            LAST_BUILT=$(jq -r '.latest.armbian_version // ""' images.json)
          fi
          echo "Last built version: $LAST_BUILT"

          # Determine if build is needed
          if [ "$UPSTREAM_VERSION" != "$LAST_BUILT" ] || [ "${{ inputs.force_build }}" == "true" ]; then
            echo "build_needed=true" >> $GITHUB_OUTPUT
            echo "Build needed: version changed or force build requested"
          else
            echo "build_needed=false" >> $GITHUB_OUTPUT
            echo "Build not needed: version unchanged"
          fi

  build:
    name: Build Armbian
    needs: check-version
    if: needs.check-version.outputs.build_needed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1024
          build-mount-path: /build
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Check available space
        run: df -h

      - name: Move Docker to larger partition
        run: |
          sudo systemctl stop docker
          sudo mv /var/lib/docker /build/docker
          sudo ln -s /build/docker /var/lib/docker
          sudo systemctl start docker
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rclone

      - name: Set up QEMU for ARM64 cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,arm

      - name: Clone Armbian build framework
        run: |
          git clone --depth=1 https://github.com/armbian/build /build/armbian-build

      - name: Build Armbian image
        run: |
          cd /build/armbian-build
          ./compile.sh build \
            BOARD=turing-rk1 \
            BRANCH=vendor \
            RELEASE=bookworm \
            BUILD_MINIMAL=no \
            BUILD_DESKTOP=no \
            KERNEL_CONFIGURE=no \
            COMPRESS_OUTPUTIMAGE=xz,sha

          # Copy output to workspace
          mkdir -p $GITHUB_WORKSPACE/armbian-build/output/images
          cp -v /build/armbian-build/output/images/*.img.xz $GITHUB_WORKSPACE/armbian-build/output/images/ || true
          cp -v /build/armbian-build/output/images/*.sha $GITHUB_WORKSPACE/armbian-build/output/images/ || true
          cp -v /build/armbian-build/output/images/*.txt $GITHUB_WORKSPACE/armbian-build/output/images/ || true
          ls -la $GITHUB_WORKSPACE/armbian-build/output/images/

      - name: Extract image metadata
        id: metadata
        run: |
          # Find the built image
          IMAGE_FILE=$(ls armbian-build/output/images/*.img.xz 2>/dev/null | head -1)
          if [ -z "$IMAGE_FILE" ]; then
            echo "Error: No image file found"
            exit 1
          fi

          FILENAME=$(basename "$IMAGE_FILE")
          SIZE=$(stat -c%s "$IMAGE_FILE")
          SIZE_HUMAN=$(numfmt --to=iec-i --suffix=B "$SIZE")
          SHA256=$(sha256sum "$IMAGE_FILE" | cut -d' ' -f1)

          # Extract kernel version from filename
          KERNEL=$(echo "$FILENAME" | grep -oP '\d+\.\d+\.\d+' | tail -1)

          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_human=$SIZE_HUMAN" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "kernel=$KERNEL" >> $GITHUB_OUTPUT

          echo "Image: $FILENAME"
          echo "Size: $SIZE_HUMAN"
          echo "SHA256: $SHA256"
          echo "Kernel: $KERNEL"

      - name: Configure rclone for Google Drive
        env:
          GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
        run: |
          # Create rclone config directory
          mkdir -p ~/.config/rclone

          # Write service account credentials
          echo "$GDRIVE_SERVICE_ACCOUNT" > /tmp/service-account.json

          # Create rclone config for Google Drive with service account
          cat > ~/.config/rclone/rclone.conf << EOF
          [gdrive]
          type = drive
          scope = drive
          service_account_file = /tmp/service-account.json
          root_folder_id = ${{ secrets.GDRIVE_FOLDER_ID }}
          EOF

          # Verify config
          rclone listremotes

      - name: Upload to Google Drive
        id: upload
        run: |
          VERSION="${{ needs.check-version.outputs.upstream_version }}"
          FILENAME="${{ steps.metadata.outputs.filename }}"
          IMAGE_FILE="armbian-build/output/images/$FILENAME"

          # Create version folder and upload
          GDRIVE_PATH="armbian-builds/turing-rk1/${VERSION}"
          rclone mkdir "gdrive:${GDRIVE_PATH}"

          # Upload image and checksum files
          rclone copy "$IMAGE_FILE" "gdrive:${GDRIVE_PATH}/" --progress
          rclone copy "armbian-build/output/images/" "gdrive:${GDRIVE_PATH}/" --include "*.sha" --include "*.txt" --progress

          # Get the file ID for the uploaded image
          FILE_INFO=$(rclone lsjson "gdrive:${GDRIVE_PATH}/${FILENAME}" 2>/dev/null | jq -r '.[0].ID // empty')

          if [ -n "$FILE_INFO" ]; then
            DOWNLOAD_URL="https://drive.google.com/open?id=${FILE_INFO}"
            echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
            echo "Uploaded to: $DOWNLOAD_URL"
          else
            echo "Warning: Could not get file ID, using path-based URL"
            DOWNLOAD_URL="https://drive.google.com/drive/folders/${{ secrets.GDRIVE_FOLDER_ID }}"
            echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          fi

          # List uploaded files
          echo "Uploaded files:"
          rclone ls "gdrive:${GDRIVE_PATH}/"

      - name: Update images.json
        run: |
          VERSION="${{ needs.check-version.outputs.upstream_version }}"
          DATE=$(date -u +%Y-%m-%d)
          DOWNLOAD_URL="${{ steps.upload.outputs.download_url }}"
          GDRIVE_FOLDER="https://drive.google.com/drive/folders/${{ secrets.GDRIVE_FOLDER_ID }}"

          # Initialize images.json if it doesn't exist
          if [ ! -f images.json ]; then
            echo '{"history":[],"build_config":{"board":"turing-rk1","branch":"vendor","release":"bookworm"}}' > images.json
          fi

          # Update images.json with new metadata
          jq --arg version "$VERSION" \
             --arg kernel "${{ steps.metadata.outputs.kernel }}" \
             --arg date "$DATE" \
             --arg filename "${{ steps.metadata.outputs.filename }}" \
             --arg size "${{ steps.metadata.outputs.size }}" \
             --arg sha256 "${{ steps.metadata.outputs.sha256 }}" \
             --arg download_url "$DOWNLOAD_URL" \
             --arg gdrive_folder "$GDRIVE_FOLDER" \
          '.latest = {
            armbian_version: $version,
            kernel_version: $kernel,
            release: "bookworm",
            branch: "vendor",
            build_date: $date,
            filename: $filename,
            size_bytes: ($size | tonumber),
            sha256: $sha256,
            download_url: $download_url,
            gdrive_folder: $gdrive_folder
          } | .history = ([{
            armbian_version: $version,
            build_date: $date,
            download_url: $download_url
          }] + .history[0:9])' images.json > images.json.tmp && mv images.json.tmp images.json

          echo "Updated images.json:"
          cat images.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images.json
          git diff --cached --quiet || git commit -m "Update Armbian image metadata for version ${{ needs.check-version.outputs.upstream_version }}"
          git push
