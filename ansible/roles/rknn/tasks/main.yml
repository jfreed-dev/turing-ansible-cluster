---
# RKNN Runtime Installation
# Installs runtime components needed for NPU inference
# Includes Python venv and DeepSeek 1.5B model

- name: Install RKNN runtime dependencies
  ansible.builtin.apt:
    name:
      - python3-pip
      - python3-numpy
      - python3-dev
      - python3-venv
    state: present

- name: Create RKNN directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /opt/rknn
    - /opt/rknn-llm
    - /opt/rkllama
    - /opt/rkllama/models
    - /root/RKLLAMA/models
    - /root/RKLLAMA/lib

- name: Clone RKNN-LLM runtime
  ansible.builtin.git:
    repo: https://github.com/airockchip/rknn-llm.git
    dest: /opt/rknn-llm
    version: main
    depth: 1

- name: Install RKNN runtime library from rknn-llm
  ansible.builtin.shell: |
    set -o pipefail
    LIBPATH=$(find /opt/rknn-llm -name "librknnrt.so" -path "*/Linux/*" -path "*/aarch64/*" | head -1)
    if [ -n "$LIBPATH" ]; then
      cp -f "$LIBPATH" /usr/lib/
      ldconfig
      echo "Installed librknnrt.so from $LIBPATH"
    else
      echo "ERROR: librknnrt.so not found in rknn-llm" >&2
      exit 1
    fi
  args:
    creates: /usr/lib/librknnrt.so
    executable: /bin/bash

- name: Clone rkllama server
  ansible.builtin.git:
    repo: https://github.com/jfreed-dev/rkllama.git
    dest: /opt/rkllama
    version: main
    depth: 1
    force: true

- name: Remove existing lib directory if not a symlink
  ansible.builtin.file:
    path: /root/RKLLAMA/lib
    state: absent
  when: ansible_facts['os_family'] == 'Debian'
  register: lib_dir_check
  failed_when: false
  changed_when: lib_dir_check.changed | default(false)

- name: Create symlink for rkllama lib
  ansible.builtin.file:
    src: /opt/rkllama/lib
    dest: /root/RKLLAMA/lib
    state: link
    force: true

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv {{ rkllama_venv_path }}
    creates: "{{ rkllama_venv_path }}/bin/python"

- name: Upgrade pip in venv
  ansible.builtin.pip:
    name:
      - pip
      - wheel
    state: latest
    virtualenv: "{{ rkllama_venv_path }}"

- name: Install rkllama Python dependencies in venv
  ansible.builtin.pip:
    name:
      - flask
      - python-dotenv
      - huggingface_hub
      - transformers
      - numpy
    virtualenv: "{{ rkllama_venv_path }}"

- name: Create RKNN environment script
  ansible.builtin.copy:
    dest: /etc/profile.d/rknn.sh
    content: |
      # RKNN Runtime Environment
      export RKNN_LLM_PATH=/opt/rknn-llm
      export RKLLAMA_PATH=/opt/rkllama
      export RKLLAMA_VENV={{ rkllama_venv_path }}
      export PATH=$PATH:$RKLLAMA_PATH:$RKLLAMA_VENV/bin
    mode: "0644"

- name: Check if model already exists
  ansible.builtin.stat:
    path: "{{ rkllm_model_path }}"
  register: model_file

- name: Download DeepSeek 1.5B model
  ansible.builtin.get_url:
    url: "{{ rkllm_model_url }}"
    dest: "{{ rkllm_model_path }}"
    mode: "0644"
    timeout: 600
  when:
    - not rkllm_skip_model_download
    - not model_file.stat.exists
  register: model_download
  retries: 2
  delay: 10

- name: Display model download status
  ansible.builtin.debug:
    msg: "Model {{ rkllm_model_name }} downloaded to {{ rkllm_model_path }}"
  when: model_download is changed

- name: Deploy rkllama systemd service
  ansible.builtin.template:
    src: rkllama.service.j2
    dest: /etc/systemd/system/rkllama.service
    mode: "0644"
  notify: Restart rkllama
  when: rkllama_service_enabled

- name: Enable and start rkllama service
  ansible.builtin.systemd:
    name: rkllama
    enabled: true
    state: started
    daemon_reload: true
  when: rkllama_service_enabled

- name: Verify NPU is accessible
  ansible.builtin.shell: |
    set -o pipefail
    if [ -c /dev/dri/renderD129 ]; then
      echo "NPU device found at /dev/dri/renderD129"
      ls -la /dev/dri/renderD129
      cat /sys/kernel/debug/rknpu/version 2>/dev/null || echo "Driver version: unknown"
      cat /sys/kernel/debug/rknpu/load 2>/dev/null || true
    elif [ -c /dev/rknpu* ]; then
      echo "NPU device found (legacy path)"
      ls -la /dev/rknpu*
    else
      echo "WARNING: NPU device not found - kernel driver may not be loaded"
      echo "Ensure you are using Armbian vendor kernel (6.1.x)"
    fi
  args:
    executable: /bin/bash
  register: rknn_npu_check
  changed_when: false

- name: Display NPU status
  ansible.builtin.debug:
    var: rknn_npu_check.stdout_lines

- name: Test RKLLM model loading
  ansible.builtin.shell: |
    {{ rkllama_venv_path }}/bin/python3 << 'EOF'
    import sys
    sys.path.insert(0, '/opt/rkllama')
    from src.rkllm import RKLLM
    import time

    print("Loading model...")
    start = time.time()
    llm = RKLLM('{{ rkllm_model_path }}')
    elapsed = time.time() - start
    print(f"Model loaded in {elapsed:.1f}s")

    with open('/sys/kernel/debug/rknpu/load') as f:
        print(f"NPU: {f.read().strip()}")

    llm.release()
    print("RKLLM test passed!")
    EOF
  args:
    executable: /bin/bash
  register: rkllm_test
  changed_when: false
  when: model_file.stat.exists or model_download is changed

- name: Display RKLLM test result
  ansible.builtin.debug:
    var: rkllm_test.stdout_lines
  when: rkllm_test is defined and rkllm_test.stdout_lines is defined
