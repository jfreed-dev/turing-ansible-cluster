---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install base packages
  ansible.builtin.apt:
    name: "{{ base_packages }}"
    state: present
  register: base_packages_installed

- name: Load required kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ base_kernel_modules | default([]) }}"

- name: Ensure kernel modules load on boot
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k3s.conf
    content: |
      {% for mod in base_kernel_modules | default([]) %}
      {{ mod }}
      {% endfor %}
    mode: "0644"

- name: Write sysctl settings file
  ansible.builtin.template:
    src: sysctl-kubernetes.conf.j2
    dest: /etc/sysctl.d/99-kubernetes.conf
    mode: "0644"
  when: base_sysctl_settings is defined
  notify: Reload sysctl

- name: Apply sysctl settings immediately
  ansible.builtin.command: sysctl -p /etc/sysctl.d/99-kubernetes.conf
  changed_when: false  # Settings already written to file; this just ensures they're active
  failed_when: false
  when: base_sysctl_settings is defined

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Update /etc/hostname file
  ansible.builtin.copy:
    content: "{{ inventory_hostname }}\n"
    dest: /etc/hostname
    mode: "0644"

- name: Update /etc/hosts
  ansible.builtin.template:
    src: hosts.j2
    dest: /etc/hosts
    mode: "0644"
  when: not (molecule_test | default(false))

- name: Set timezone
  community.general.timezone:
    name: "{{ base_timezone | default('America/Chicago') }}"

# iSCSI configuration for Longhorn
- name: Configure iSCSI for Longhorn
  when: "'open-iscsi' in base_packages"
  block:
    - name: Ensure iscsid service is enabled and started
      ansible.builtin.systemd:
        name: iscsid
        state: started
        enabled: true

    - name: Ensure iscsi socket is enabled
      ansible.builtin.systemd:
        name: iscsid.socket
        state: started
        enabled: true
      failed_when: false

    - name: Verify iSCSI initiator name exists
      ansible.builtin.stat:
        path: /etc/iscsi/initiatorname.iscsi
      register: base_iscsi_initiator

    - name: Generate iSCSI initiator name if missing
      ansible.builtin.shell: |
        echo "InitiatorName=$(iscsi-iname)" > /etc/iscsi/initiatorname.iscsi
      when: not base_iscsi_initiator.stat.exists
      changed_when: true
