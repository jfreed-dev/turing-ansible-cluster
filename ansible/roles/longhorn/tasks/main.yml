---
- name: Label nodes for Longhorn default disk creation
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Node
      metadata:
        name: "{{ item }}"
        labels:
          node.longhorn.io/create-default-disk: "true"
  loop: "{{ groups['k3s_cluster'] }}"

- name: Add Longhorn Helm repo
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
    state: present

- name: Create Longhorn namespace
  kubernetes.core.k8s:
    name: longhorn-system
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        labels:
          pod-security.kubernetes.io/enforce: privileged
          pod-security.kubernetes.io/audit: privileged
          pod-security.kubernetes.io/warn: privileged

- name: Deploy Longhorn
  kubernetes.core.helm:
    name: longhorn
    chart_ref: longhorn/longhorn
    chart_version: "{{ helm_charts.longhorn.version | default('1.7.2') }}"
    release_namespace: longhorn-system
    create_namespace: false
    values: "{{ lookup('file', playbook_dir + '/../files/helm-values/longhorn.yml') | from_yaml }}"
    wait: true
    wait_timeout: 600s

- name: Wait for Longhorn to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: longhorn-system
    name: longhorn-driver-deployer
  register: longhorn_deployer
  until: longhorn_deployer.resources[0].status.readyReplicas | default(0) >= 1
  retries: 30
  delay: 10

- name: Create Longhorn ingress
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: longhorn-ingress
        namespace: longhorn-system
        annotations:
          nginx.ingress.kubernetes.io/proxy-body-size: "0"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
      spec:
        ingressClassName: nginx
        rules:
          - host: "{{ ingress_hosts.longhorn | default('longhorn.local') }}"
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: longhorn-frontend
                      port:
                        number: 80
